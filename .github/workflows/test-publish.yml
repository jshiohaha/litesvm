name: Test Publish (Fork)

# This workflow allows you to test the full build and publish pipeline on your fork
# without interfering with the main repository

on:
  workflow_dispatch:
    inputs:
      npm_package_name:
        description: 'NPM package name (e.g., @jshiohaha/litesvm)'
        required: true
        default: '@jshiohaha/litesvm'
      dry_run:
        description: 'Dry run (do not actually publish)'
        type: boolean
        default: true

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        settings:
          - host: macos-latest
            target: x86_64-apple-darwin
            build: yarn build --target x86_64-apple-darwin
          - host: macos-latest
            target: aarch64-apple-darwin
            build: yarn build --target aarch64-apple-darwin
          - host: ubuntu-20.04
            target: x86_64-unknown-linux-gnu
            build: yarn build --target x86_64-unknown-linux-gnu --use-napi-cross
          - host: ubuntu-latest
            target: x86_64-unknown-linux-musl
            build: yarn build --target x86_64-unknown-linux-musl -x
          - host: ubuntu-20.04
            target: aarch64-unknown-linux-gnu
            build: yarn build --target aarch64-unknown-linux-gnu --use-napi-cross
          - host: ubuntu-latest
            target: aarch64-unknown-linux-musl
            build: yarn build --target aarch64-unknown-linux-musl -x
    name: Build ${{ matrix.settings.target }}
    runs-on: ${{ matrix.settings.host }}
    defaults:
      run:
        working-directory: crates/node-litesvm
    steps:
      - uses: actions/checkout@v5
      - name: Setup node
        uses: actions/setup-node@v5
        with:
          node-version: 22
          cache: yarn
          cache-dependency-path: crates/node-litesvm/yarn.lock
      - name: Install Rust
        uses: dtolnay/rust-toolchain@nightly
        with:
          toolchain: stable
          targets: ${{ matrix.settings.target }}
      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            ~/.napi-rs
            .cargo-cache
            target/
          key: ${{ matrix.settings.target }}-cargo-${{ matrix.settings.host }}
      - uses: mlugg/setup-zig@v2
        if: ${{ contains(matrix.settings.target, 'musl') }}
        with:
          version: 0.14.1
      - name: Install cargo-zigbuild
        uses: taiki-e/install-action@v2
        if: ${{ contains(matrix.settings.target, 'musl') }}
        env:
          GITHUB_TOKEN: ${{ github.token }}
        with:
          tool: cargo-zigbuild
      - name: Install dependencies
        run: yarn install
      - name: Build
        run: ${{ matrix.settings.build }}
        shell: bash
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: bindings-${{ matrix.settings.target }}
          path: crates/node-litesvm/litesvm/litesvm.*.node
          if-no-files-found: error

  publish:
    name: Test Publish
    runs-on: ubuntu-latest
    needs: build
    steps:
      - uses: actions/checkout@v5
      - name: Setup node
        uses: actions/setup-node@v5
        with:
          node-version: 22
          check-latest: true
          cache: yarn
          cache-dependency-path: crates/node-litesvm/yarn.lock
      - name: Install dependencies
        run: cd crates/node-litesvm/ && corepack enable && yarn install

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: crates/node-litesvm/artifacts

      - name: Move artifacts to litesvm directory
        run: |
          cd crates/node-litesvm/
          echo "Moving .node files to litesvm/ directory..."
          find artifacts -name "*.node" -exec cp {} litesvm/ \;
          echo "Artifacts moved:"
          ls -lh litesvm/*.node

      - name: Compile TypeScript
        run: cd crates/node-litesvm/ && yarn build:js

      - name: Copy internal.js and .node files to dist
        run: |
          cd crates/node-litesvm/
          echo "Copying internal.js (NAPI-generated, should not be transpiled)..."
          cp litesvm/internal.js dist/internal.js
          cp litesvm/internal.js.map dist/internal.js.map 2>/dev/null || true
          echo "âœ… Copied internal.js to dist/"

          echo "Copying .node files to dist..."
          cp litesvm/*.node dist/
          echo "âœ… Copied .node files to dist/"

          echo "Final dist/ contents:"
          ls -lh dist/*.node | head -10

      # Update package for publishing
      - name: Update package name
        if: ${{ inputs.npm_package_name != 'litesvm' }}
        run: |
          cd crates/node-litesvm/
          npm pkg set name="${{ inputs.npm_package_name }}"

      - name: Update files array to only publish dist
        run: |
          cd crates/node-litesvm/
          echo "Setting files array to only include dist/ (everything is there now)..."
          npm pkg set files='["dist/"]'
          echo "âœ… Package will only publish dist/ directory"

      - name: List package contents
        run: |
          cd crates/node-litesvm/
          echo "ðŸ“¦ Package contents that will be published:"
          echo ""
          echo "dist/ directory:"
          ls -lh dist/ | head -20
          echo ""
          echo "litesvm/ directory:"
          ls -lh litesvm/*.node 2>/dev/null || echo "No .node files in litesvm/"
          echo ""
          echo "Checking if TypeScript compiled internal.js to dist/:"
          test -f dist/internal.js && echo "âœ… dist/internal.js exists" || echo "âŒ dist/internal.js missing"
          echo ""
          echo "Package.json settings:"
          cat package.json | grep -A5 '"main"\|"files"'

      - name: Dry run check
        if: ${{ inputs.dry_run }}
        run: |
          echo "ðŸ” DRY RUN MODE - Package will NOT be published"
          echo ""
          echo "Package contents that would be published:"
          cd crates/node-litesvm/
          npm pack --dry-run
          echo ""
          echo "To publish for real, uncheck 'dry_run' and run again"

      - name: Publish to npm
        if: ${{ !inputs.dry_run }}
        run: |
          cd crates/node-litesvm/
          echo "//registry.npmjs.org/:_authToken=$NPM_TOKEN" >> ~/.npmrc
          npm publish --access public --ignore-scripts
        env:
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Success message
        if: ${{ !inputs.dry_run }}
        run: |
          echo "âœ… Successfully published ${{ inputs.npm_package_name }}!"
          echo "You can install it with: npm install ${{ inputs.npm_package_name }}"
